\CUSDependency{ module={util}, package={multicol, varwidth, rotating, lscape, (ROTpdf)pdflscape} }
\CUSProvideExplModule{box}{\cus@d@te}{\cus@versi@n}{box, breakable box}

% modify framed.sty 
\skip_new:N \l__cus_box_outer_skip 
\skip_set:Nn \l__cus_box_outer_skip \c_max_dim
\dim_new:N \l__cus_box_width_dim % width be to align
\dim_set_eq:NN \l__cus_box_width_dim \c_max_dim
\fp_new:N \l__cus_box_ratio_fp % width to total frame ratio, text:frame 
\fp_set:Nn \l__cus_box_ratio_fp { 1 }

\cs_new_protected_nopar:Npn \cus_varwidth:nnw #1#2 % pos, max width
  { \group_begin: \varwidth [#1] { \dim_eval:n {#2} } }
\cs_new_protected_nopar:Npn \cus_varwidth_end: { \endvarwidth \group_end: }
\cs_new_protected_nopar:Npn \cus_set_varwidth:Nnnw #1#2#3
  { \hbox_set:Nw #1 \varwidth [#2] { \dim_eval:n {#3} } }
\cs_new_protected_nopar:Npn \cus_set_varwidth_end: { \endvarwidth \hbox_set_end: }

\cs_new_protected:Npn \cus_set_vbox_width:Nnw #1#2 % box num, width
  {
    \vbox_set:Nw #1 
    \dim_set:Nn \tex_hsize:D {#2}
    \textwidth\tex_hsize:D \columnwidth\tex_hsize:D
    \legacy_if:nTF { @in@minipage@env }
      {
        \box_if_empty:NF \@mpfootins 
          { \@latex@warning { Nested~minipage:~footnotes~may~be~misplaced } }
      }
      { \legacy_if_set_true:n { @in@minipage@env } }
    \@parboxrestore 
    \tl_set:Nn \@mpfn { mpfootnote }
    \tl_set:Nn \thempfn { \thempfootnote }
    \int_zero:N \c@mpfootnote 
    \cs_set_eq:NN \@footnotetext \@mpfootnotetext 
    \cs_set_eq:NN \@listdepth \@mplistdepth 
    \int_zero:N \@mplistdepth
    \@minipagerestore \@setminipage
  }
\cs_new_protected:Npn \cus_gset_vbox_width:Nnw 
  { \tex_global:D \cus_set_vbox_width:Nnw }
\cs_new_protected:Npn \cus_set_vbox_width_end:
  {
    \par \tex_unskip:D 
    \box_if_empty:NF \@mpfootins 
      {
        \tex_vskip:D \tex_skip:D \@mpfootins 
        \normalcolor \footnoterule 
        \vbox_unpack_drop:N \@mpfootins 
      }
    \legacy_if_set_false:n { @minipage }
    \vbox_set_end:
  }
\cs_new_eq:NN \cus_gset_vbox_width_end: \cus_set_vbox_width_end:
\cs_new_protected:Npn \cus_set_vbox_varwidth:Nnw
  {
    \cs_set_eq:NN \@minipagerestore \@vwid@setup
    \cus_set_vbox_width:Nnw 
  }
\cs_new_protected:Npn \cus_gset_vbox_varwidth:Nnw
  {
    \cs_set_eq:NN \@minipagerestore \@vwid@setup
    \cus_gset_vbox_width:Nnw 
  }
\cs_set_eq:NN \__cus_tmp: \endvarwidth 
\ctex_patch_cmd_once:NnnnTF \__cus_tmp: 
  { \makeatletter }
  { \endminipage } 
  { 
    \cus_set_vbox_width_end: 
    \cs_set_eq:NN \@minipagerestore \@@vwid@minipagerestore
  } 
  { } { \cus_patch_failure:N \endvarwidth }
\cs_new_protected:Npx \cus_set_vbox_varwidth_end: { \exp_not:o \__cus_tmp: }
\cs_new_eq:NN \cus_gset_vbox_varwidth_end: \cus_set_vbox_varwidth_end:


% \cs_new_protected:Npn \cus_peek_minipage:Nnnnw #1#2#3#4 % box num, vpos, width, code, 
%   {
%     \tl_set:Nn \__cus_peek_minipage: { \minipage [#2] {#3} }
%     \tl_set:Nn \__cus_peek_minipage_auxii: 
%       { \endminipage \c_group_end_token #4 }
%     \tex_afterassignment:D \__cus_peek_minipage_auxi:
%     \tex_setbox:D #1 \tex_hbox:D 
%   }
% \cs_new:Npn \__cus_peek_minipage_auxi:
%   {
%     \__cus_peek_minipage: \c_group_begin_token
%     \group_insert_after:N \__cus_peek_minipage_auxii:
%   }
\cs_new_protected:Npn \__cus_box_vb:N #1
  { \vbox:n { \vbox_unpack_drop:N #1 } }
\cs_new_eq:NN \__cus_box_v:N \__cus_box_vb:N 
\cs_new_protected:Npn \__cus_box_vt:N #1
  { \vbox_top:n { \vbox_unpack_drop:N #1 } }
\cs_new_protected:Npn \__cus_box_vc:N #1
  { \m@th $ \tex_vcenter:D { \vbox_unpack_drop:N #1 } $ }
\cs_new_protected:Npn \cus_peek_minipage:Nnnnw #1#2#3#4 % box num, code, vpos, width, 
  {
    \cs_set:Npx \__cus_peek_minipage: 
      { \cus_set_vbox_width:Nnw \l__cus_tmpa_box \exp_not:n { {#4} } }
    \cs_set:Npx \__cus_peek_minipage_auxii: 
      { 
        \cus_set_vbox_width_end: 
        \use:c { __cus_box_v#3:N } \l__cus_tmpa_box 
        \c_group_end_token 
        \exp_not:n {#2} 
      }
    \tex_afterassignment:D \__cus_peek_minipage_auxi:
    \tex_setbox:D #1 \tex_hbox:D 
  }
\cs_new:Npn \__cus_peek_minipage_auxi:
  {
    \__cus_peek_minipage: \c_group_begin_token
    \group_insert_after:N \__cus_peek_minipage_auxii:
  }
\cs_new:Npn \cus_peek_width:Nnnnw { \cus_peek_minipage:Nnnnw }
% full version: box num, code, vpos, height, inner pos, width, 
\cs_new_protected:Npn \cus_peek_minipage:Nnnnnnw #1#2#3#4#5#6
  {
    \cs_set:Npx \__cus_peek_minipage:
      { \cus_set_vbox_width:Nnw \l__cus_tmpa_box \exp_not:n { {#6} } }
    \cs_set:Npx \__cus_peek_minipage_auxii:
      {
        \cus_set_vbox_width_end: 
        \exp_not:N \@iiiparbox 
          {#3} {#4} [#5] { \dim_eval:n {#6} } { \vbox_unpack_drop:N \l__cus_tmpa_box }
        \c_group_end_token
        \exp_not:n {#2}
      }
    \tex_afterassignment:D \__cus_peek_minipage_auxi: 
    \tex_setbox:D #1 \tex_hbox:D 
  }
\cs_new:Npn \cus_peek_width:Nnnnnnw { \cus_peek_minipage:Nnnnnnw }
% \cs_new_protected:Npn \cus_peek_varwidth:Nnnnw #1#2#3#4 % box num, vpos, width, code, 
%   {
%     \tl_set:Nn \__cus_peek_varwidth: { \varwidth [#2] {#3} }
%     \tl_set:Nn \__cus_peek_varwidth_auxii: 
%       { \endvarwidth \c_group_end_token #4 }
%     \tex_afterassignment:D \__cus_peek_varwidth_auxi:
%     \tex_setbox:D #1 \tex_hbox:D 
%   }
% \cs_new:Npn \__cus_peek_varwidth_auxi:
%   {
%     \__cus_peek_varwidth: \c_group_begin_token
%     \group_insert_after:N \__cus_peek_varwidth_auxii:
%   }
\cs_new_protected:Npn \cus_peek_varwidth:Nnnnw #1#2#3#4 % box num, code, vpos, width, 
  {
    \cs_set:Npx \__cus_peek_varwidth: 
      { \cus_set_vbox_varwidth:Nnw \l__cus_tmpa_box \exp_not:n { {#4} } }
    \cs_set:Npx \__cus_peek_varwidth_auxii: 
      { 
        \cus_set_vbox_varwidth_end: 
        \use:c { __cus_box_v#3:N } \l__cus_tmpa_box 
        \c_group_end_token 
        \exp_not:n {#2} 
      }
    \tex_afterassignment:D \__cus_peek_varwidth_auxi:
    \tex_setbox:D #1 \tex_hbox:D 
  }
\cs_new:Npn \__cus_peek_varwidth_auxi:
  {
    \__cus_peek_varwidth: \c_group_begin_token
    \group_insert_after:N \__cus_peek_varwidth_auxii:
  }
% full version: box num, code, vpos, height, inner pos, width, 
\cs_new_protected:Npn \cus_peek_varwidth:Nnnnnnw #1#2#3#4#5#6
  {
    \cs_set:Npx \__cus_peek_varwidth:
      { \cus_set_vbox_varwidth:Nnw \l__cus_tmpa_box \exp_not:n { {#6} } }
    \cs_set:Npx \__cus_peek_varwidth_auxii:
      {
        \cus_set_vbox_varwidth_end: 
        \exp_not:N \@iiiparbox 
          {#3} {#4} [#5] { \dim_eval:n {#6} } { \vbox_unpack_drop:N \l__cus_tmpa_box }
        \c_group_end_token
        \exp_not:n {#2}
      }
    \tex_afterassignment:D \__cus_peek_varwidth_auxi: 
    \tex_setbox:D #1 \tex_hbox:D 
  }

\cs_new_protected_nopar:Npn \cus_ref_label_width:nnnn #1 % label, vpos, width, 
  {
    \cus_peek_minipage:Nnnnw \l__cus_tmpc_box
      { 
        \cus_ref_label:nn {#1} { \XeTeXLinkBox { \box_use_drop:N \l__cus_tmpc_box } }
      }
  }
\cs_new_protected_nopar:Npn \cus_ref_label_varwidth:nnnn #1
  {
    \cus_peek_varwidth:Nnnnw \l__cus_tmpc_box
      { 
        \cus_ref_label:nn {#1} { \XeTeXLinkBox { \box_use_drop:N \l__cus_tmpc_box } }
      }
  }
\cs_new_protected_nopar:Npn \cus_ref_target_width:nnnn #1 % target, vpos, width, 
  {
    \cus_peek_minipage:Nnnnw \l__cus_tmpc_box
      { 
        \cus_ref_target:nn {#1} { \XeTeXLinkBox { \box_use_drop:N \l__cus_tmpc_box } }
      }
  }
\cs_new_protected_nopar:Npn \cus_ref_target_varwidth:nnnn #1
  {
    \cus_peek_varwidth:Nnnnw \l__cus_tmpc_box
      { 
        \cus_ref_target:nn {#1} { \XeTeXLinkBox { \box_use_drop:N \l__cus_tmpc_box } }
      }
  }


\cs_new_protected:Npn \__cus_box_update_geometry:nN #1#2 % group end code, box num
  {
    \use:e 
      {
        \exp_not:n {#1}
        \cs_set:Npn \exp_not:N \width { \dim_use:N \box_wd:N #2 }
        \cs_set:Npn \exp_not:N \height { \dim_use:N \box_wd:N #2 }
        \cs_set:Npn \exp_not:N \depth { \dim_use:N \box_wd:N #2 }
        \cs_set:Npn \exp_not:N \totalheight { \dim_use:N \box_ht_plus_dp:N #2 }
      }
  }
\cs_new_protected:Npn \__cus_box_update_geometry_x:N #1 % box num
  {
    \cs_set:Npx \height { \dim_use:N \box_ht:N #1 }
    \cs_set:Npx \width { \dim_use:N \box_wd:N #1 }
    \cs_set:Npx \depth { \dim_use:N \box_dp:N #1 }
    \cs_set:Npx \totalheight { \dim_use:N \box_ht_plus_dp:N #1 }
  }


% cannot be used in math mode!
\cs_new_protected:Npn \cus_box_start:nn #1#2
  {
    \par
    \nointerlineskip 
    \group_begin:
    \cs_set:Npn \footnotemark 
      { \msg_warning:nn { cus } { box-footnote } \__cus_use_none_o:w }
    \cs_set:Npn \footnotetext 
      { \msg_warning:nn { cus } { box-footnote } \__cus_use_none_om:w }
    \cs_set:Npn \footnote 
      { \msg_warning:nn { cus } { box-footnote } \__cus_use_none_om:w }
    \if_dim:w \l__cus_box_width_dim = \c_max_dim
      \dim_set_eq:NN \l__cus_box_width_dim \textwidth
    \fi:
    \if_dim:w \l__cus_box_outer_skip = \c_max_dim
      \skip_set:Nn \l__cus_box_outer_skip { 8pt plus 8pt minus 6pt }
    \fi:
    \keys_set:nn { cus/frame } {#1}
    \dim_set:Nn \tex_hsize:D { \fp_use:N \l__cus_box_ratio_fp \l__cus_box_width_dim }
    \__cus_box_frame_measure:N \__cus_box_frame_nosplit:n 
    \cs_set_eq:NN \width \l__cus_box_wd_dim
    \cs_set_eq:NN \height \l__cus_box_ht_dim
    % insert pre-penalties and skips
    \group_begin:
    \skip_set_eq:NN \skip@ \lastskip
    \if@nobreak \else
      \tex_penalty:D 9999 ~ % updates \page parameters
      \ifdim\pagefilstretch=\z@ \ifdim\pagefillstretch=\z@
        % not infinitely stretchable, so encourage a page break here 
        \str_if_eq:eeTF { \skip_use:N \skip@ } { \skip_use:N \c_zero_skip }
          { \tex_penalty:D -30 ~ }
          { \tex_vskip:D -\skip@ \tex_penalty:D -30 ~ \skip_vertical:N \skip@ }
      \fi:\fi:
      \tex_penalty:D \c_zero_int
      % Give a stretchy breakpoint that will always be taken in preference
      % to the \penalty 9999 used to update page parameters.  The cube root
      % of 10000/100 indicates a multiplier of 0.21545, but the maximum 
      % calculated badness is really 8192, not 10000, so the multiplier
      % is 0.2301.
      \skip_add:Nn \skip@ 
        {
            \c_zero_dim plus -.5\baselineskip
          + \c_zero_dim plus -.231\height
          + \c_zero_dim plus -.231\skip@
          + \c_zero_dim plus -.231\l__cus_box_outer_skip
        }
      \tex_vskip:D -\skip@ \tex_penalty:D 1800 ~ \skip_vertical:N \skip@
    \fi:
    \addvspace { \l__cus_box_outer_skip }
    \group_end:
    % clear out pending page break
    \tex_penalty:D \@M \tex_vskip:D 2\baselineskip \tex_vskip:D \height
    \tex_penalty:D 9999 ~ \tex_vskip:D -2\baselineskip \tex_vskip:D -\height
    \tex_penalty:D 9999~ % updates \pagetotal
    \__cus_box_adjust_height: 
    \vbox_set:Nw \@tempboxa 
      #2 % Modifications to \hsize (can use \width and \height)
      \dim_set_eq:NN \textwidth \tex_hsize:D 
      \dim_set_eq:NN \columnwidth \tex_hsize:D
      \l__cus_box_init_tl
  }

\cs_new_protected:Npn \cus_box_stop: 
  {
      \par 
      \tex_kern:D \c_zero_dim 
      \tex_hrule:D \@width\tex_hsize:D \@height\c_zero_dim % possibly bad
      \tex_penalty:D -100 ~ % (\hrule moves depth into height)
    \vbox_set_end:
    \group_begin: 
      \__cus_box_put:NNN \@tempboxa \__cus_box_frame_nosplit:n \__cus_box_frame_first:n 
    \group_end:
    \nointerlineskip
    \group_end:
    \@minipagefalse % In case it was set and not cleared 
  }

% \__cus_box_put:NNN takes the contents of box #1 and puts all, or a piece,
% of it on the page with a frame (\__cus_box_frame:n , \__cus_box_frame_first:n ,
% \__cus_box_frame_middle:n , or \__cus_box_frame_last:n ).  It recurses until all of 
% box #1 has been used up. (box #1 must have zero depth.)
% #2 = attempted framing command, if no split
% #3 = framing command if split
% First iteration: Try to fit with \__cus_box_frame_nosplit:n . If it does not fit,
% split for \__cus_box_frame_first:n .
% Later iteration: Try to fit with \__cus_box_frame_last:n . If it does not
% fit, split for \__cus_box_frame_middle:n .
\cs_new_nopar:Npn \__cus_box_put:NNN #1 #2 #3
  {
    \scan_stop:
    \if_dim:w \tex_pagegoal:D = \c_max_dim \tex_pagegoal:D \tex_vsize:D \fi: 
    \if_mode_inner:
      \__cus_box_put_aux:NN #1#2%
      \__cus_box_after: 
    \else:
      % natural space left on page
      \dim_set:Nn \dimen@ { \tex_pagegoal:D - \tex_pagetotal:D } 
      \if_dim:w \dimen@ < 2\baselineskip % Too little room on page
        \eject \__cus_box_adjust_height: \__cus_box_put:NNN #1#2#3
      \else % there's appreciable room left on the page
        \__cus_box_frame_measure:N #2
        \group_begin: % temporarily set \dimen@ to be...
        % maximum space available on page for content 
        \dim_add:Nn \dimen@ { 0.8 \tex_pageshrink:D - \l__cus_box_ht_dim }
        %%% LOOKS SUBTRACTED AND ADDED, SO DOUBLE ACCOUNTING!
        \exp_after:wN \group_end:
        % expand \ifdim, then restore \dimen@ to real room left on page
        \if_dim:w \dimen@ > \box_ht:N #1 % whole box does fit
          % ToDo: Change this to use vsplit anyway to capture the marks
          % MERGE THIS WITH THE else CLAUSE!!!
          \__cus_box_put_aux:NN #1#2%
          \__cus_box_after: 
        \else % box must be split
          % update frame measurement to use \__cus_box_frame_first:n or \__cus_box_frame_middle:n 
          \__cus_box_frame_measure:N #3
          \vbox_set:Nn #1
            {% simulate frame and flexiblity of the page:
              \tex_vskip:D \l__cus_box_ht_dim \@plus\tex_pagestretch:D \@minus0.8\tex_pageshrink:D 
              \tex_kern:D 137sp \tex_kern:D -137sp \tex_penalty:D -30 ~
              \vbox_unpack_drop:N #1
            }
          \cs_set_nopar:Npx \__cus_box_restore:
            {
              \tex_boxmaxdepth:D = \dim_use:N \tex_boxmaxdepth:D 
              \tex_splittopskip:D = \skip_use:N \tex_splittopskip:D 
            }
          \dim_zero:N \tex_boxmaxdepth:D 
          \skip_zero:N \tex_splittopskip:D 
          \vbox_set_split_to_ht:NNn \tw@ #1 \dimen@
  %%      \toks99\expandafter{\splitfirstmark}%
  %%      \toks98\expandafter{\splitbotmark}%
          \vbox_set:Nn \tw@ { \vbox_unpack_drop:N \tw@ } % natural-sized 
          % If the split-to width > (\vsize-\topskip), then set box to full width.
          \dim_compare:nNnTF { \dimen@ + \tex_topskip:D } > { \tex_pagegoal:D }
            { 
              \dim_set:Nn \dimen@ii 
                { \tex_pagegoal:D - \tex_topskip:D + \l__cus_box_adjust_height_tl  } 
            }
            {% suspect this is implemented incorrectly:
              % If the split-to width > feasible room_on_page, rebox it smaller.
              \tex_advance:D \dimen@ .8\pageshrink
              \if_dim:w \box_ht:N \tw@ > \dimen@
                \dimen@ii = \dimen@
              \else: % use natural width
                \dimen@ii = \box_ht:N \tw@
              \fi:
            }
          % Re-box contents to desired width \dimen@ii
          \dim_add:Nn \dimen@ii { -\l__cus_box_ht_dim }
          \vbox_set_to_ht:Nnw \tw@ { \dimen@ii }
            % remove simulated frame and page flexibility:
            \tex_vskip:D -\l__cus_box_ht_dim \@plus-\pagestretch \@minus-.8\pageshrink
            \vbox_unpack_drop:N \tw@ 
            \tex_unpenalty:D \tex_unpenalty:D 
          \if_dim:w \tex_lastkern:D = -137sp % whole box went to next page
            % need work here???
            \vbox_set_end: 
            \__cus_box_restore: 
            \eject % (\vskip for frame width was discarded) 
            \__cus_box_adjust_height: 
            \__cus_box_put:NNN #1#2#3 % INSERTED ???
          \else: % Got material split off at the head
            \vbox_set_end:
            \__cus_box_restore:
            \if_box_empty:N #1 % it all fit after all 
              \box_set_eq:NN #1 \tw@ 
              \__cus_box_put_aux:NN #1#2
              \__cus_box_after: 
            \else: % it really did split
              \if_dim:w \box_wd:N \tw@ > \c_zero_dim 
                \box_set_wd:Nn \tw@ { \box_wd:N #1 }
                \__cus_box_put_aux:NN \tw@ #3
              \else:
                \box_use_drop:N \tw@
              \fi:
              \tex_hrule:D \@height\z@ \@width\tex_hsize:D 
              \eject
              \__cus_box_adjust_height: 
              \__cus_box_put:NNN #1 \__cus_box_frame_last:n \__cus_box_frame_middle:n 
      \fi:\fi:\fi:\fi:\fi:
  }

\cs_new:Npn \__cus_box_hbox_center:n #1
  { \hbox_to_wd:nn \l__cus_box_width_dim { \tex_hss:D #1 \tex_hss:D } }
\cs_new:Npn \__cus_box_hbox_left:n #1
  { \hbox_to_wd:nn \l__cus_box_width_dim { #1 \tex_hss:D } }
\cs_new:Npn \__cus_box_hbox_right:n #1
  { \hbox_to_wd:nn \l__cus_box_width_dim { \tex_hss:D #1 } }
\cs_new:Npn \__cus_box_hbox_outer:n
  { 
    \if_int_odd:w \c@page \exp_after:wN \__cus_box_hbox_right:n 
    \else: \exp_after:wN \__cus_box_hbox_left:n 
    \fi:
  }
\cs_new:Npn \__cus_box_hbox_inner:n
  { 
    \if_int_odd:w \c@page \exp_after:wN \__cus_box_hbox_left:n 
    \else: \exp_after:wN \__cus_box_hbox_right:n 
    \fi:
  }
\cs_new:Npn \__cus_box_hbox_absouter:n
  { 
    \if_int_odd:w \g_shipout_readonly_int \exp_after:wN \__cus_box_hbox_left:n 
    \else: \exp_after:wN \__cus_box_hbox_right:n 
    \fi:
  }
\cs_new_eq:cN { __cus_box_hbox_outer*:n } \__cus_box_hbox_absouter:n 
\cs_new:Npn \__cus_box_hbox_absinner:n
  { 
    \if_int_odd:w \g_shipout_readonly_int \exp_after:wN \__cus_box_hbox_right:n 
    \else: \exp_after:wN \__cus_box_hbox_left:n 
    \fi:
  }
\cs_new_eq:cN { __cus_box_hbox_inner*:n } \__cus_box_hbox_absinner:n 
\cs_new_eq:NN \__cus_box_hbox:n \__cus_box_hbox_center:n 
\cs_new_nopar:Npn \__cus_box_put_aux:NN #1#2
  {
    \if_box_empty:N #1
    \else:
      \__cus_box_hbox:n 
        {
          \__cus_box_update_geometry_x:N #1
          #2 { \box_use_drop:N #1 }
        }
    \fi:
  }

\cs_new_nopar:Npn \__cus_box_after: 
  {
    \nointerlineskip \null
    \tex_penalty:D -30 ~ 
    \skip_vertical:N \l__cus_box_outer_skip
  }

% measure width and height added by frame (#1 = frame command)
% call results \l__cus_box_wd_dim and \l__cus_box_ht_dim
% todo: a mechanism to handle wide frame titles 
\dim_new:N \l__cus_box_wd_dim
\dim_new:N \l__cus_box_ht_dim
\cs_new_protected_nopar:Npn \__cus_box_frame_measure:N #1
  {
    \group_begin:
    \vbox_set:Nn \z@ 
      {
        \skip_vertical:n { -5in }
        \hbox:n 
          { 
            \cs_set:Npn \height { 5in }
            \cs_set:Npn \width { 5in }
            \cs_set:Npn \depth { 0pt }
            \cs_set:Npn \totalheight { 5in }
            \skip_horizontal:n { -5in }
            #1 { \hbox:n { \tex_vrule:D \@height 4.7in \@depth.3in \@width 5in } } 
          }
        \skip_vertical:N \c_zero_skip
      }
    \dim_gset:Nn \l__cus_box_wd_dim { \box_wd:N \z@ }
    \dim_gset:Nn \l__cus_box_ht_dim { \box_ht:N \z@ }
    \group_end:
  }

\cs_new:Npn \__cus_box_adjust_height: 
  {
    \vbox_to_ht:nn \l__cus_box_adjust_height_tl { } % get proper baseline skip from above.
    \tex_penalty:D \@M 
    \nointerlineskip
    \tex_vskip:D -\l__cus_box_adjust_height_tl 
    \tex_penalty:D \@M
  } % useful for tops of pages

\cs_new_protected:Npn \__cus_box_frame:nnn #1#2#3
  {
    \group_begin:
      \hbox_set:Nn \l__box_internal_box {#3}
      \hbox:n
        {
          \__cus_kern:n { #1 + #2 } % l sep 
          \box_use:N \l__box_internal_box
          \__cus_kern:n { - \box_wd:N \l__box_internal_box - #2 - #1 } % l 
          \box_move_down:nn { \box_dp:N \l__box_internal_box + #2 + #1 }
            {
              \vbox:n
                {
                  \cus_rule_horizontal:nn {#1} { \c_zero_dim }
                  \hbox:n
                    {
                      \cus_rule_vertical:n {#1}
                      \__cus_kern:n { #2 * 2 + \box_wd:N \l__box_internal_box }
                      \vbox:n
                        {
                          \__cus_kern:n 
                            {
                                  #2 * 2
                              + \box_dp:N \l__box_internal_box
                              + \box_ht:N \l__box_internal_box
                            }
                        }
                      \cus_rule_vertical:n {#1}
                    }
                  \cus_rule_horizontal:nn {#1} { \c_zero_dim }
                }
            }
        }
    \group_end:
  }
\cs_new_protected:Npn \__cus_box_frame:NNNNnnn #1#2#3#4#5#6#7 % l, b, r, t, 
  {
    \group_begin:
      \hbox_set:Nn \l__box_internal_box {#7}
      \hbox:n
        {
          \__cus_kern:n { \if_int_odd:w #1 \exp_stop_f: #5 + #6 \else: 0pt \fi: }
          \box_use:N \l__box_internal_box
          \__cus_kern:n { - \box_wd:N \l__box_internal_box \if_int_odd:w #1 - #6 - #5 \fi: }
          \box_move_down:nn { \box_dp:N \l__box_internal_box \if_int_odd:w #4 + #6 + #5 \fi: }
            {
              \vbox:n
                {
                  \cus_rule_horizontal:nn { \if_int_odd:w #2 \exp_stop_f: #5 \else: 0pt \fi: } { \c_zero_dim }
                  \hbox:n
                    {
                      \cus_rule_vertical:n { \if_int_odd:w #1 \exp_stop_f: #5 \else: 0pt \fi: }
                      \__cus_kern:n { \if_int_odd:w #1 + #6 \fi: \if_int_odd:w #3 + #6 \fi: + \box_wd:N \l__box_internal_box }
                      \vbox:n
                        {
                          \__cus_kern:n 
                            {
                              + \if_int_odd:w #2 \exp_stop_f: #6 \fi:
                              + \if_int_odd:w #4 \exp_stop_f: #6 \fi:
                              + \box_dp:N \l__box_internal_box
                              + \box_ht:N \l__box_internal_box
                            }
                        }
                      \cus_rule_vertical:n { \if_int_odd:w #3 \exp_stop_f: #5 \else: 0pt \fi:}
                    }
                  \cus_rule_horizontal:nn { \if_int_odd:w #4 \exp_stop_f: #5 \else: 0pt \fi: } { \c_zero_dim }
                }
            }
        }
    \group_end:
  }
\cs_new_protected:Npn \__cus_box_frame:ffn #1#2
  { \exp_args:Nff \__cus_box_frame:nnn { \dim_eval:n {#1} } { \dim_eval:n {#2} } }
% Provide configuration commands:
\cs_new_protected:Npn \__cus_box_frame:n 
  { \__cus_box_frame:nnn \cusframerule \cusframesep }
\cs_new_nopar:Npn \cusborderframe { \__cus_box_frame:NNNNn }
\cs_new_protected:Npn \__cus_box_frame:NNNNn #1#2#3#4
  { \__cus_box_frame:NNNNnnn #1#2#3#4 \cusframerule \cusframesep }
\dim_new:N \cusframerule
\dim_set:Nn \cusframerule { \fboxrule }
\dim_new:N \cusframesep
\dim_set:Nn \cusframesep { 3\fboxsep }
\cs_new_protected:Npn \__cus_box_frame_first:n   { \__cus_box_frame:n }
\cs_new_protected:Npn \__cus_box_frame_middle:n  { \__cus_box_frame:n }
\cs_new_protected:Npn \__cus_box_frame_last:n    { \__cus_box_frame:n }
\cs_new_protected:Npn \__cus_box_frame_nosplit:n { \__cus_box_frame:n }

% Height of frame above first baseline when frame starts a page:
\tl_set:Nn \l__cus_box_adjust_height_tl { 6pt }

% \__cus_box_init: has parts of \@parboxrestore, performing a similar but 
% less complete restoration of the default layout.  See how it is used in
% the "settings" argument of \MakeFrame.  Though not a parameter, \hsize 
% should be set to the desired total line width available inside the
% frame before invoking \__cus_box_init:.  
\cs_new_protected:Npn \__cus_box_init:
  {
    \cs_set_eq:NN \if@nobreak \if_false:
    \cs_set_eq:NN \if@noskipsec \if_false:
    \cs_set_eq:NN \- \@dischyph
    \cs_set_eq:NN \' \@acci \cs_set_eq:NN \` \@accii \cs_set_eq:NN \= \@acciii
    % Test if we are in a list (or list-like paragraph)
    \if_int_compare:w
        \if_dim:w \@totalleftmargin>\z@ 1\fi:
        \if_dim:w \rightmargin>\z@ 1\fi:
        \if_dim:w \@listdepth\p@ >\c_zero_dim 1\fi: 
        0 > \c_zero_int
      \@setminipage % snug fit around the item.  I would like this to be non-global.
      % Now try to propageate changes of width from \hsize to list parameters.
      % This is deficient, but a more advanced way to indicate modification to text 
      % dimensions is not (yet) provided; in particular, no separate left/right
      % adjustment.
      \dim_add:Nn \linewidth { \tex_hsize:D - \columnwidth }
      \tex_parshape:D \@ne \@totalleftmargin \linewidth
    \else: % Not in list 
      \dim_set_eq:NN \linewidth \tex_hsize:D 
    \fi:
    \sloppy
  }

\msg_new:nnn { cus } { box-footnote } { Footnote~in~framed~box,~I'm~going~to~ignore~it. }

\keys_define:nn { cus } { frame .meta:nn = { cus/frame } {#1} }
\keys_define:nn { cus/frame }
  {
    outer-sep .skip_set:N = \l__cus_box_outer_skip ,
    sep .dim_set:N = \cusframesep ,
    rule-width .dim_set:N = \cusframerule ,
    frame .cs_set:Np = \__cus_box_frame:n ,
    frame* .cs_set:Np = \__cus_box_frame:n #1 ,
    first .cs_set:Np = \__cus_box_frame_first:n ,
    first* .cs_set:Np = \__cus_box_frame_first:n #1 ,
    middle .cs_set:Np = \__cus_box_frame_middle:n ,
    middle* .cs_set:Np = \__cus_box_frame_middle:n #1 ,
    last .cs_set:Np = \__cus_box_frame_last:n ,
    last* .cs_set:Np = \__cus_box_frame_last:n #1 ,
    whole .cs_set:Np = \__cus_box_frame_nosplit:n ,
    whole* .cs_set:Np = \__cus_box_frame_nosplit:n # ,
    width .dim_set:N = \l__cus_box_width_dim ,
    ratio .fp_set:N = \l__cus_box_ratio_fp , % width be to align
    ratio .initial:n = 1 ,
    init .tl_set:N = \l__cus_box_init_tl ,

    % alignment 
    align .code:n = \cs_set_eq:Nc \__cus_box_hbox:n { __cus_box_hbox_ #1:n } ,
    left   .meta:n = { align = left   } ,
    center .meta:n = { align = center } ,
    right  .meta:n = { align = right  } ,
    inner  .meta:n = { align = inner  } ,
    outer  .meta:n = { align = outer  } ,
    absinner .meta:n = { align = absinner  } ,
    absouter .meta:n = { align = absouter  } ,
    inner* .meta:n = { align = absinner  } ,
    outer* .meta:n = { align = absouter  } ,

    ignore-warnings .code:n = 
      {
        \int_set:Nn \tex_vbadness:D { 10000 }
        \int_set:Nn \tex_tolerance:D { 10000 }
        \dim_set_eq:NN \tex_vfuzz:D \c_max_dim 
      } ,
    ignore-warnings .value_forbidden:n = true ,
  }

% \NewDocumentEnvironment { Framed } { O{} }
\newenvironment{ Framed } [1] []
  { \cus_box_start:nn {#1} { \dim_sub:Nn \tex_hsize:D { \width } \__cus_box_init: } } 
  { \cus_box_stop: }



\hook_gput_code:nnn { package/xcolor/after } { cus/pkg/after } { \cus_color_set:nn { cusfiller } { black } }
\cus_color_set:nn { cusfiller } { black }
\skip_new:N \l__cus_filler_skip
\skip_set:Nn \l__cus_filler_skip { 0pt plus 1fill }
\dim_new:N \l__cus_filler_sep_dim
\bool_new:N \l__cus_filler_full_bool
\box_new:N \l__cus_filler_box
\tl_new:N \l__cus_filler_space_tl
\dim_new:N \l__cus_filler_rule_width_dim
\keys_define:nn { cus/filler }
  {
    size .skip_set:N = \l__cus_filler_skip ,
    size* .code:n = \skip_set:Nn \l__cus_filler_skip { 0pt plus #1 } ,
    size* .default:n = 1fill ,

    dash .dim_set:N = \l__cus_filler_sep_dim ,
    dash .default:n = 0.44em ,
    sep .meta:n = { dash = {#1} } ,
    rule .dim_set:N = \l__cus_filler_rule_width_dim ,
    rule .initial:n = 0.4pt ,
    full .bool_set:N = \l__cus_filler_full_bool ,
    raise .dim_set:N = \l__cus_filler_raise_dim ,
    is-dash .meta:n = { not-box , not-content } ,
    is-dash .value_forbidden:n = true ,

    content .tl_set:N = \l__cus_filler_content_tl ,
    box .code:n = \hbox_set:Nn \l__cus_filler_box {#1} , % do not set color
    box* .code:n = \hbox_set_to_wd:Nnn \l__cus_filler_box #1 ,
    clear-content .code:n = \tl_clear:N \l__cus_filler_content_tl ,
    clear-content .value_forbidden:n = true ,
    clear-box .code:n = \box_clear:N \l__cus_filler_box ,
    clear-box .value_forbidden:n = true ,
    not-content .meta:n = { clear-content , clear-box } ,
    not-content .value_forbidden:n = true ,

    space .tl_set:N = \l__cus_filler_space_tl ,
    space .default:n = \tex_hfill:D ,
    hspace .code:n = \tl_set:Nx \l__cus_filler_space_tl 
      { \exp_not:N \hspace { \skip_eval:n {#1} } } ,
    hspace* .code:n = \tl_set:Nn \l__cus_filler_space_tl 
      { \exp_not:N \hspace* { \skip_eval:n {#1} } } ,
    vspace .code:n = \tl_set:Nx \l__cus_filler_space_tl 
      { \exp_not:N \vspace { \skip_eval:n {#1} } } ,
    vspace* .code:n = \tl_set:Nn \l__cus_filler_space_tl 
      { \exp_not:N \vspace* { \skip_eval:n {#1} } } ,
    not-space .code:n = \tl_clear:N \l__cus_filler_space_tl ,
    not-space .value_forbidden:n = true ,
    
    solid .meta:n = { not-space , not-content , dash = 0pt } ,
    dashed .meta:n = { not-space , not-content , dash = {#1} } ,
    dashed .default:n = { 0.5ex } ,
    dotted .meta:n = 
      { 
        not-space , 
        content = 
          { \hbox_to_wd:nn {#1} { \tex_hss:D . \tex_hss:D } } 
      } ,
    dotted .default:n = { 0.44em } ,
    cdotted .meta:n = 
      { 
        not-space , 
        content = 
          { \hbox_to_wd:nn {#1} { \tex_hss:D $ \cdot $ \tex_hss:D } } 
      } ,
    cdotted .default:n = { 0.44em } ,

    type .choice: ,
    type / align .code:n = \cs_set:Npn \__cus_filler_aux:nn { \cus_align_leaders:nn } ,
    type / center .code:n = \cs_set:Npn \__cus_filler_aux:nn { \cus_center_leaders:nn } ,
    type / spread .code:n = \cs_set:Npn \__cus_filler_aux:nn { \cus_spread_leaders:nn } ,
    align  .meta:n = { type = align  } ,
    center .meta:n = { type = center } ,
    spread .meta:n = { type = spread } ,
    color .code:n = \cus_color_set:nn { cusfiller } {#1} ,
  }
\cs_new_protected_nopar:Npn \cus_filler:n #1
  {
    \group_begin:
    \keys_set:nn { cus/filler } {#1}
    \tl_if_empty:NTF \l__cus_filler_space_tl
      { 
        \if_mode_math: \exp_after:wN \__cus_filler_math: 
        \else: \exp_after:wN \__cus_filler: 
        \fi: 
      } 
      { \l__cus_filler_space_tl }
    \group_end:
  }
\cs_new:Npn \__cus_filler:
  {
    \__cus_leave_vertical:
    \if_box_empty:N \l__cus_filler_box
      \tl_if_empty:NTF \l__cus_filler_content_tl
        {
          \if_dim:w \l__cus_filler_sep_dim = \c_zero_dim
            \cus_color_select:n { cusfiller }
            \__cus_filler_aux:nn 
              { 
                \cus_rule_horizontal:nn 
                  { \l__cus_filler_rule_width_dim + \l__cus_filler_raise_dim } 
                  { -\l__cus_filler_raise_dim }
              }
              { \l__cus_filler_skip }
          \else:
            \bool_if:NTF \l__cus_filler_full_bool
              {
                \dim_set:Nn \l__cus_tmpa_dim 
                  { 
                    \skip_if_finite:nTF { \l__cus_filler_skip } 
                      { \l__cus_filler_skip + \tex_gluestretch:D \l__cus_filler_skip - \tex_glueshrink:D \l__cus_filler_skip }
                      { \linewidth }
                  }
                \cus_dash_approx:nnnn \l__cus_filler_raise_dim
                  \l__cus_tmpa_dim
                  \l__cus_filler_rule_width_dim
                  \l__cus_filler_sep_dim
              }
              {
                \hbox_set:Nn \l__cus_filler_box 
                  { 
                    \cus_color_select:n { cusfiller }
                    \cus_rule:nnn { \l__cus_filler_sep_dim }
                      { \l__cus_filler_rule_width_dim + \l__cus_filler_raise_dim } 
                      { - \l__cus_filler_raise_dim }
                    \skip_horizontal:N \l__cus_filler_sep_dim 
                  }
                \__cus_filler_aux:nn { \box_use_drop:N \l__cus_filler_box } { \l__cus_filler_skip }
              }
          \fi:
        }
        { 
          \hbox_set:Nn \l__cus_filler_box 
            { \cus_color_select:n { cusfiller } \l__cus_filler_content_tl } 
          \__cus_filler_aux:nn { \box_use_drop:N \l__cus_filler_box } { \l__cus_filler_skip }
        }
    \else:
      \__cus_filler_aux:nn { \box_use_drop:N \l__cus_filler_box } { \l__cus_filler_skip }
    \fi:
    \tex_kern:D \c_zero_dim
  }
\cs_new_protected_nopar:Npn \cus_dash_approx:nnnn #1#2#3#4 % raise, width, rule, sep 
  {
    \__cus_leave_vertical:
    \hbox_to_wd:nn {#2}
      {
        \cus_color_select:n { cusfiller }
        \int_set:Nn \l_tmpa_int 
          { 
            2 * \int_div_round:nn { \int_value:w \tex_dimexpr:D #2 } 
                                  { 2 * \int_value:w \tex_dimexpr:D #4 } + 1
          }
        \dim_set:Nn \l_tmpa_dim { \dim_eval:n {#2} / \l_tmpa_int }
        \cus_align_leaders:nn 
          { \hbox:n { \cus_rule:nnn { \l_tmpa_dim } { #3+#1+0pt } { -#1+0pt } \skip_horizontal:N \l_tmpa_dim } } 
          {#2}
        \hbox_overlap_left:n { \cus_rule:nnn { \l_tmpa_dim } { #3 + #1 + 0pt } { -#1+0pt } }
      }
  }
\cs_new_eq:NN \__cus_filler_math: \__cus_filler:
\cs_new:Npn \__cus_filler_aux:nn { \cus_align_leaders:nn }
\NewDocumentCommand \filler { O{} } { \cus_filler:n {#1} }
\NewDocumentCommand \dashfiller { O{0pt} G{\linewidth} !O{1ex} !O{0.4pt} } % r, w, s, ru
  { \exp_args:Nnff \cus_dash_approx:nnnn {#1} { \dim_eval:n {#2} } { \dim_eval:n {#4} } {#3} }
\NewDocumentCommand \atleastfiller { O{} m } % filler at least #2 width
  { 
    \cus_filler:n { #1, size*=#2 } 
    \tex_penalty:D -100~ 
    \hbox:n { } \cus_filler:n {#1} 
  }
\NewDocumentCommand \breakablefiller { O{} }
  {
    \tex_unskip:D
    \cus_filler:n { #1, size*=1fill }
    \tex_penalty:D 500~ \hbox:n { } \nobreak
    \cus_filler:n { #1, size*=10000fil }
    \cus@ignorespaces
  }


\cs_new:Npn \__cus_align_leaders:nn  #1 { \tex_leaders:D  #1 }
\cs_new:Npn \__cus_center_leaders:nn #1 { \tex_cleaders:D #1 }
\cs_new:Npn \__cus_spread_leaders:nn #1 { \tex_xleaders:D #1 }
\cs_new:Npn \__cus_kern:n #1 { \tex_kern:D \dim_eval:n {#1} \exp_stop_f: }
\cs_new:Npn \__cus_leave_vertical:
  { \if_mode_vertical: \exp_after:wN \tex_noindent:D \fi: }

\cs_new_protected:Npn \cus_align_leaders:nn #1#2
  { \__cus_leave_vertical: \tex_leaders:D #1 \tex_hskip:D \skip_eval:n {#2} \exp_stop_f: \scan_stop: }
\cs_new_protected:Npn \cus_center_leaders:nn #1#2
  { \__cus_leave_vertical: \tex_cleaders:D #1 \tex_hskip:D \skip_eval:n {#2} \exp_stop_f: \scan_stop: }
\cs_new_protected:Npn \cus_spread_leaders:nn #1#2
  { \__cus_leave_vertical: \tex_xleaders:D #1 \tex_hskip:D \skip_eval:n {#2} \exp_stop_f: \scan_stop: }
\cs_new_protected:Npn \cus_kern_horizontal:n #1
  {
    \mode_leave_vertical:
    \__cus_kern:n {#1}
  }
\cs_new_protected:Npn \cus_kern_vertical:n #1
  {
    \mode_if_vertical:F { \par }
    \__cus_kern:n {#1}
  }
\cs_new_protected:Npn \cus_rule:nnn #1#2#3
  {
    \tex_vrule:D
      height \dim_eval:n {#2} \exp_stop_f:
      depth  \dim_eval:n {#3} \exp_stop_f:
      width  \dim_eval:n {#1} \exp_stop_f:
      \scan_stop:
  }
\cs_new_protected:Npn \cus_rule_horizontal:nn #1#2
  {
    \tex_hrule:D
      height \dim_eval:n {#1} \exp_stop_f:
      depth  \dim_eval:n {#2} \exp_stop_f:
      \scan_stop:
  }
\cs_new_protected:Npn \cus_rule_vertical:n #1
  { \tex_vrule:D width \dim_eval:n {#1} \exp_stop_f: \scan_stop: }
\cs_new_protected:Npn \cus_draw_rule:nnnn #1#2#3#4 { } % wd, ht, dp, color set


\clist_map_inline:nn
  { 
    , width 
    , height
    , sep 
    , rule 
    , border-width
    , border-left-width
    , border-top-width
    , border-right-width
    , border-bottom-width
    , border-style
    , border-left-style
    , border-top-style
    , border-right-style
    , border-bottom-style
    , padding 
    , padding-left 
    , padding-top 
    , padding-right 
    , padding-bottom 
    , size
    , left
    , top
    , right
    , bottom
    , left*
    , top*
    , right*
    , bottom*
    , leftrule 
    , toprule 
    , rightrule 
    , bottomrule 
  }
  { \tl_new:c { c__cus_registered_geometry_options_#1_tl } }
\cs_new_protected:Npn \__cus_filter_geometry_options:NNN #1#2#3
  { 
    \clist_set_eq:NN \l__cus_filter_geometry_a_clist \c_empty_clist
    \clist_set_eq:NN \l__cus_filter_geometry_b_clist \c_empty_clist
    \keyval_parse:nno 
      { \__cus_filter_geometry_options_aux:n }
      { \__cus_filter_geometry_options_aux:nn }
      #1
    \clist_set_eq:NN #2 \l__cus_filter_geometry_a_clist
    \clist_set_eq:NN #3 \l__cus_filter_geometry_b_clist
  }
\cs_new:Npn \__cus_filter_geometry_options_aux:n #1
  {
    \cs_if_exist:cTF { c__cus_registered_geometry_options_ #1 _tl }
      { \clist_put_right:Nn \l__cus_filter_geometry_a_clist {#1} }
      { \clist_put_right:Nn \l__cus_filter_geometry_b_clist {#1} }
  }
\cs_new:Npn \__cus_filter_geometry_options_aux:nn #1#2
  {
    \cs_if_exist:cTF { c__cus_registered_geometry_options_ #1 _tl }
      { \clist_put_right:Nn \l__cus_filter_geometry_a_clist {#1={#2}} }
      { \clist_put_right:Nn \l__cus_filter_geometry_b_clist {#1={#2}} }
  }


% multicol
%% patch multicol
\cs_new_protected:Npn \cus@update@multi@framedgeometry #1 { }
\cs_new_protected:Npn \cus@update@multi@height #1 { }
\cs_new_protected:Npn \cus@update@multi@width #1 { }
\cs_new_protected:Npn \cus@update@multi@box #1 {#1}
\cs_new_protected:Npn \cus@update@multi@boxes #1#2 { }
\cs_new_protected:Npn \cus@update@multi@rule 
  { \columnseprulecolor\vrule\@width\columnseprule }
\cs_new_eq:NN \cus@multicol@drawrule \cus_draw_rule:nnnn 
\cs_new_protected:Npn \cus@multicol@swapcolumninevenpages #1#2#3
  {
    \ifodd\cus@multicol@swapcolumn 
      \if@twoside 
        \ifodd\c@page #3
        \else \ifx#3#1 #2\else #1\fi 
        \fi 
      \else #3
      \fi 
    \else #3
    \fi 
  }
\cs_set_eq:NN \cus@update@multi@boxes \cus@multicol@swapcolumninevenpages 
%% see multicolrule.sty
\dim_new:N \l__cus_multicolumns_rule_extend_top_dim
\dim_new:N \l__cus_multicolumns_rule_extend_bot_dim
\cs_new_protected:Npn \cus@multicol@rule 
  { 
    \dim_set:Nn \l__cus_tmpa_dim 
      {
        \box_ht:N \mult@rightbox + % height
        \dim_max:nn {\dimen\tw@} {\box_dp:N \mult@rightbox} + % depth
        \dim_max:nn {\box_ht:N \mult@nat@firstbox - \box_ht:N \mult@rightbox} {0pt} % overflow
      }
    \box_move_down:nn 
      { 
        \dim_max:nn {\dimen\tw@} {\box_dp:N \mult@rightbox} + % depth
        \dim_max:nn {\box_ht:N \mult@nat@firstbox - \box_ht:N \mult@rightbox} {0pt} % % overflow
      }
      {
        \vbox_to_ht:nn \l__cus_tmpa_dim 
          {
            \tex_vss:D
            \hbox:n
              {
                \use:e 
                  {
                    \exp_not:N \cus@multicol@drawrule 
                      { \dim_use:N \columnseprule } 
                      { \dim_eval:n { \l__cus_tmpa_dim + \l__cus_multicolumns_rule_extend_top_dim + \l__cus_multicolumns_rule_extend_bot_dim } } 
                      { \dim_use:N \c_zero_dim } 
                      { \exp_not:N \columnseprulecolor } 
                  }
              }
            \tex_vss:D 
          }
      }
  }
\dim_new:N \cus@multicol@extra@height 
\dim_new:N \cus@multicol@extra@width 
%%
% ref: https://tex.stackexchange.com/a/132461/232375
% \cs_set:Npn \__cus_tmp:w #1\hbox to\full@width#2#3!!
%   {
%     \def\page@sofar{#1\cus@update@multi@box{\hbox to\full@width{#2}}#3}
%   }
% \exp_after:wN \__cus_tmp:w \page@sofar!!
\ctex_patch_cmd:Nnn \page@sofar 
  { \hbox to\full@width { \mc@align@columns \rlap{ \phantom p } } }
  { 
    \cus@update@multi@box 
      {
        \hbox to\full@width 
          { \cus@update@multi@boxes\LR@column@boxes\RL@column@boxes\mc@align@columns 
            \rlap{ \phantom p } }
      }
  }
% \def\foo#1\hsize\linewidth#2!!{%
%   \def\prepare@multicols{#1%
%     \advance\linewidth-\cus@multicol@extra@width 
%     \hsize\linewidth#2}}
% \expandafter\foo\prepare@multicols!!
\ctex_patch_cmd:Nnn \prepare@multicols { \hsize\linewidth }
  {
    \advance\linewidth-\cus@multicol@extra@width 
    \hsize\linewidth
  }
% \def\foo#1\dimen@\@colroom#2!!{%
%   \def\multi@column@out{#1%
%     \advance\@colroom-\cus@multicol@extra@height 
%     \dimen@\@colroom#2}}
% \expandafter\foo\prepare@multicols!!
\ctex_patch_cmd:Nnn \multi@column@out { \dimen@\@colroom }
  {
    \advance\@colroom-\cus@multicol@extra@height 
    \dimen@\@colroom 
  }
\cs_set_eq:NN \cus@restore@LR@column@boxes \LR@column@boxes
\cs_set_eq:NN \cus@restore@RL@column@boxes \RL@column@boxes
\ctex_patch_cmd:Nnn \LR@column@boxes 
  { \columnseprulecolor\vrule\@width\columnseprule }
  { \cus@update@multi@rule }
\ctex_patch_cmd:Nnn \RL@column@boxes 
  { \columnseprulecolor\vrule\@width\columnseprule }
  { \cus@update@multi@rule }
\cs_set_eq:NN \mc@align@columns \LR@column@boxes 
\hook_gput_code:nnn { package/multicolrule/before } { cus/patch }
  {
    \cs_set_eq:NN \LR@column@boxes \cus@restore@LR@column@boxes
    \cs_set_eq:NN \RL@column@boxes \cus@restore@RL@column@boxes
  }
\RequirePackage {adjmulticol}
\tl_new:N \l__cus_multicolumns_adj_inner_tl 
\tl_new:N \l__cus_multicolumns_adj_outer_tl 
%%end-of patch
\keys_define:nn { cus } { multicolumns .meta:nn = { cus/multicolumns } {#1} }
\keys_define:nn { cus/multicolumns } 
  {
    columns .code:n = \tl_set:Nx \l__cus_multicolumns_cols_tl { \int_eval:n {#1} } ,
    columns .initial:n = 2 ,
    cols .meta:n = { columns = {#1} } ,
    first-minimal .dim_set:N = \premulticols ,
    last-minimal .dim_set:N = \postmulticols ,
    outer-skip .skip_set:N = \multicolsep ,
    outer-sep .meta:n = { outer-skip = {#1} } ,
    column-sep .dim_set:N = \columnsep ,
    sep .meta:n = { column-sep = {#1} } ,
    heading .tl_set:N = \l__cus_multicolumns_heading_tl ,
    rule-width .dim_set:N = \columnseprule ,
    rule-color .code:n = 
      \tl_set:Nn \columnseprulecolor { \__cus_key_color_select:n {#1} } ,
    ragged .code:n = \raggedcolumns ,
    ragged .value_forbidden:n = true ,
    not-aligned .meta:n = { ragged } ,
    not-aligned .value_forbidden:n = true ,
    flush .code:n = \flushcolumns ,
    flush .value_forbidden:n = true ,
    aligned .meta:n = { flush } ,
    aligned .value_forbidden:n = true ,
    balanced .bool_set:N = \l__cus_multicolumns_balanced_bool ,
    balanced .initial:n = true ,
    not-balanced .code:n = \bool_set_false:N \l__cus_multicolumns_balanced_bool ,
    not-balanced .value_forbidden:n = true ,
    columns* .meta:n = { not-balanced , columns = {#1} } ,
    cols*    .meta:n = { columns* = {#1} } ,

    enable-swap-column .code:n = 
      \cs_set_eq:NN \cus@update@multi@boxes \cus@multicol@swapcolumninevenpages ,
    enable-swap-column .value_forbidden:n = true ,
    disable-swap-column .code:n = \cs_set_eq:NN \cus@update@multi@boxes \use_none:nn ,
    disable-swap-column .value_forbidden:n = true ,
    swap-column .bool_set:N = \cus@multicol@swapcolumn ,

    adj .bool_set:N = \l__cus_multicolumns_adj_bool ,
    adj-inner .code:n = \bool_set_true:N \l__cus_multicolumns_adj_bool 
      \tl_set:Nx \l__cus_multicolumns_adj_inner_tl { \dim_eval:n {#1} } ,
    adj-outer .code:n = \bool_set_true:N \l__cus_multicolumns_adj_bool 
      \tl_set:Nx \l__cus_multicolumns_adj_outer_tl { \dim_eval:n {#1} } ,
    adj*      .meta:n = { adj , not-balanced } ,

    framed .choice: ,
    framed-options  .clist_set:N = \cus@multicol@framed@options ,
    framed-options+ .clist_put_right:N = \cus@multicol@framed@options ,
    rule-top .dim_set:N = \l__cus_multicolumns_rule_extend_top_dim ,
    rule-bottom .dim_set:N = \l__cus_multicolumns_rule_extend_bot_dim ,

    % be careful to use
    addto-baselineskip .dim_set:N = \multicolbaselineskip ,
    tolerance .int_set:N = \multicoltolerance , % 9999
    pretolerance .int_set:N = \multicolpretolerance ,
    collectmore .int_set:N = \c@collectmore ,
    minrows .int_set:N = \c@minrows , % 1
    unbalance .int_set:N = \c@unbalance ,
    column-badness .int_set:N = \c@columnbadness ,
    final-column-badness .int_set:N = \c@finalcolumnbadness , % 9999
    top-fuzz .dim_set:N = \multicolovershoot , % 0pt 
    bottom-fuzz .dim_set:N = \multicolundershoot , % 2pt 
    bot-fuzz .meta:n = { bottom-fuzz = {#1} } ,
    v-fuzz .meta:n = { top-fuzz = {#1} , bottom-fuzz = {#1} } ,
    h-fuzz .dim_set:N = \tex_hfuzz:D ,
    overflow .dim_set:N = \maxbalancingoverflow , % 12pt 
    right-to-left .code:n = \RLmulticolcolumns ,
    right-to-left .value_forbidden:n = true ,
    RL .meta:n = { right-to-left } ,
    RL .value_forbidden:n = true ,
    left-to-right .code:n = \LRmulticolcolumns ,
    left-to-right .value_forbidden:n = true ,
    LR .meta:n = { left-to-right } ,
    LR .value_forbidden:n = true ,

    unknown .code:n = 
      { 
        \cus_if_head_int:fTF { \l_keys_key_str } 
          { \tl_set:Nx \l__cus_multicolumns_cols_tl { \int_eval:n { \l_keys_key_str } } } 
          { \msg_error:nnxx { cus } { unknown-key } { multicolumns } { \l_keys_key_str } }
      } ,
  }
\cs_new_protected:Npn \__cus_multicolumns_process_framedoptions: 
  {
    \hbox_set:Nn \c_zero_int % we never use it 
      { 
        \exp_args:No \cus@update@multi@framedgeometry { \cus@multicol@framed@options } 
        \cus@update@multi@height \cus@multicol@extra@height 
        \cus@update@multi@width  \cus@multicol@extra@width 
        \dim_gset_eq:NN \cus@multicol@extra@height \cus@multicol@extra@height 
        \dim_gset_eq:NN \cus@multicol@extra@width  \cus@multicol@extra@width
      }
  }
\keys_define:nn { cus/multicolumns }
  {
    framed / fbox .code:n = 
      {
        \cs_set_protected:Npn \cus@update@multi@height ##1
          { ##1=\dimexpr2\fboxrule+2\fboxsep\relax }
        \cs_set_eq:NN \cus@update@multi@width \cus@update@multi@height 
        \cs_set_protected:Npn \cus@update@multi@box ##1
          { \hbox{\fbox{##1}} }
        \cs_set_protected:Npn \cus@update@multi@framedgeometry ##1 
          { \keyval_parse:nnn \use_none:n \__cus_set_fbox_geometry:nn {##1} }
      }
  }
\cs_new_protected:Npn \__cus_set_fbox_geometry:nn #1#2
  {
    \str_case:nn {#1}
      {
        { sep }  { \dim_set:Nn \fboxsep {#2} }
        { rule } { \dim_set:Nn \fboxrule {#2} }
        { border } { \dim_set:Nn \fboxrule {#2} }
        { border-width } { \dim_set:Nn \fboxrule {#2} }
        { padding } { \dim_set:Nn \fboxsep {#2} }
      }
  }
\cs_new_protected_nopar:Npn \cus@startmulticolumns { \begin{multicols} }
\cs_new_protected_nopar:Npn \cus@stopmulticolumns  { \end{multicols} }
\NewDocumentCommand \startmulticolumns { +O{} }
  {
    \group_begin:
    \keys_set:nn { cus/multicolumns } {#1}
    \__cus_multicolumns_process_framedoptions: 
    \int_compare:nNnTF \l__cus_multicolumns_cols_tl < 2
      { 
        \bool_if:NTF \l__cus_multicolumns_adj_bool 
          {
            \cs_set:Npx \cus@startmulticolumns 
              { 
                \exp_not:N \begin
                  {adjmulticols \bool_if:NF \l__cus_multicolumns_balanced_bool * }
                  { 1 } 
                  { \l__cus_multicolumns_adj_inner_tl }
                  { \l__cus_multicolumns_adj_outer_tl }
                  [ \exp_not:N \l__cus_multicolumns_heading_tl ]
              }
            \cs_set:Npx \cus@stopmulticolumns 
              {
                \exp_not:N \end 
                  {adjmulticols \bool_if:NF \l__cus_multicolumns_balanced_bool * }
              }
          }
          {
            \cs_set:Npn \cus@startmulticolumns { \l__cus_multicolumns_heading_tl }
            \cs_set_eq:NN \cus@stopmulticolumns \prg_do_nothing: 
          }
      }
      {
        \bool_if:NTF \l__cus_multicolumns_adj_bool 
          {
            \cs_set:Npx \cus@startmulticolumns 
              {
                \exp_not:N \begin 
                  { adjmulticols \bool_if:NF \l__cus_multicolumns_balanced_bool * }
                  { \l__cus_multicolumns_cols_tl }
                  { \l__cus_multicolumns_adj_inner_tl }
                  { \l__cus_multicolumns_adj_outer_tl }
                  [ \exp_not:N \l__cus_multicolumns_heading_tl ]
              }
            \cs_set:Npx \cus@stopmulticolumns 
              {
                \exp_not:N \end 
                  { adjmulticols \bool_if:NF \l__cus_multicolumns_balanced_bool * }
              }
          }
          {
            \cs_set:Npx \cus@startmulticolumns 
              {
                \exp_not:N \begin 
                  { multicols \bool_if:NF \l__cus_multicolumns_balanced_bool * }
                  { \l__cus_multicolumns_cols_tl }
                  [ \exp_not:N \l__cus_multicolumns_heading_tl ]
              }
            \cs_set:Npx \cus@stopmulticolumns 
              {
                \exp_not:N \end 
                  { multicols \bool_if:NF \l__cus_multicolumns_balanced_bool * }
              }
          }
      }
    \cus@startmulticolumns \relax 
  }
\cs_new_protected_nopar:Npn \stopmulticolumns { \cus@stopmulticolumns \group_end: }



\keys_define:nn { cus } { rotate .meta:nn = { cus/rotate } {#1} }
\keys_define:nn { cus/rotate }
  {
    sideways .code:n = 
      \cs_set_eq:NN \__cus_rotate_start:w \sideways
      \cs_set_eq:NN \__cus_rotate_stop:w \endsideways ,
    turn .code:n = 
      \cs_set_nopar:Npn \__cus_rotate_start:w { \turn { \fp_eval:n {#1} } }
      \cs_set_eq:NN \__cus_rotate_stop:w \endturn ,
    turn .default:n = 90 ,
    rotate .code:n = 
      \cs_set_nopar:Npn \__cus_rotate_start:w 
        { \Grot@setangle{ \fp_eval:n {#1} } \setbox\z@\color@hbox\ignorespaces } 
      \cs_set_eq:NN \__cus_rotate_stop:w \endrotate ,
    rotate .default:n = 90 ,
    nospaceturn .meta:n = { rotate = {#1} } ,
    nospaceturn .default:n = 90 ,
    float .code:n = 
      \cs_set_nopar:Npn \__cus_rotate_start:w { \@rotfloat {#1} }
      \cs_set_eq:NN \__cus_rotate_stop:w \end@rotfloat ,
    float* .code:n = 
      \cs_set_nopar:Npn \__cus_rotate_start:w { \@rotdblfloat {#1} }
      \cs_set_eq:NN \__cus_rotate_stop:w \end@rotdblfloat ,
    table .meta:n = { float = table } ,
    table* .meta:n = { float* = table } ,
    figure .meta:n = { float = figure } ,
    figure* .meta:n = { float* = figure } ,
    unknown .code:n = 
      {
        \cus_if_endstar:NTF \l_keys_key_str
          {
            \cs_set_nopar:Npx \__cus_rotate_start:w 
              { \exp_not:N \@rotdblfloat { \cus_unstar:N \l_keys_key_str } }
            \cs_set_eq:NN \__cus_rotate_stop:w \end@rotdblfloat
          }
          {
            \cs_set_nopar:Npx \__cus_rotate_start:w 
              { \exp_not:N \@rotfloat { \l_keys_key_str } }
            \cs_set_eq:NN \__cus_rotate_stop:w \end@rotfloat
          }
      } ,
  }
\cs_new:Npn \__cus_rotate_start:w { \sideways }
\cs_new:Npn \__cus_rotate_stop:w { \endsideways }

\NewDocumentCommand \startrotate { O{sideways} }
  {
    \keys_set:nn { cus/rotate } {#1}
    \__cus_rotate_start:w 
  }
\cs_new_protected_nopar:Npn \stoprotate { \__cus_rotate_stop:w }
\NewDocumentCommand \Rotate { O{rotate} +m }
  {
    \keys_set:nn { cus/rotate } {#1}
    \__cus_rotate_start:w #1 \__cus_rotate_stop:w 
  }